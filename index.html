<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Polygon Amoy smartcontract test with Web3Modal</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    button { margin: 5px; padding: 10px 20px; font-size: 16px; }
    #output { margin-top: 20px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>Polygon Amoy smartcontract test with Web3Modal</h1>
  <!-- ウォレット接続用のボタンを追加 -->
  <button id="connectWalletButton">ウォレット接続</button>
  <button id="readButton">isTimeElapsed call (read only)</button>
  <button id="writeButton">mint call</button>
  <div id="output"></div>

  <!-- ethers.js の UMD ビルド -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <!-- WalletConnectProvider の UMD ビルド -->
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
  <!-- Web3Modal の UMD ビルド -->
  <script src="https://unpkg.com/web3modal@1.9.5/dist/index.js"></script>

  <script>
    /*****************************************************
     * 注意:
     * このサンプルでは Alchemy の API キーを直接コード内に記述しています。
     * 本番環境では、Alchemy ダッシュボードの「Allowed Domains」等を利用し、
     * 利用可能なドメインを限定するなどの対策を必ず実施してください。
     *****************************************************/

    // --- 設定 ---
    const ALCHEMY_API_KEY = "QKAjvFhFCHEzWBpCWG49O8ao8zsw8878"; // ドメイン制限済
    const RPC_URL = "https://polygon-amoy.g.alchemy.com/v2/" + ALCHEMY_API_KEY;
    const CONTRACT_ADDRESS = "0xBDC4Ba6C52BCb242D0fDdf9Ff52a30dd6C1B7063";
    const CONTRACT_ABI = [
      {
        "inputs": [],
        "stateMutability": "nonpayable",
        "type": "constructor"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "address", "name": "owner", "type": "address" },
          { "indexed": true, "internalType": "address", "name": "approved", "type": "address" },
          { "indexed": true, "internalType": "uint256", "name": "tokenId", "type": "uint256" }
        ],
        "name": "Approval",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "address", "name": "owner", "type": "address" },
          { "indexed": true, "internalType": "address", "name": "operator", "type": "address" },
          { "indexed": false, "internalType": "bool", "name": "approved", "type": "bool" }
        ],
        "name": "ApprovalForAll",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": false, "internalType": "uint256", "name": "tokenId", "type": "uint256" }
        ],
        "name": "TimeElapsed",
        "type": "event"
      },
      {
        "anonymous": false,
        "inputs": [
          { "indexed": true, "internalType": "address", "name": "from", "type": "address" },
          { "indexed": true, "internalType": "address", "name": "to", "type": "address" },
          { "indexed": true, "internalType": "uint256", "name": "tokenId", "type": "uint256" }
        ],
        "name": "Transfer",
        "type": "event"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "to", "type": "address" },
          { "internalType": "uint256", "name": "tokenId", "type": "uint256" }
        ],
        "name": "approve",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "owner", "type": "address" }
        ],
        "name": "balanceOf",
        "outputs": [
          { "internalType": "uint256", "name": "", "type": "uint256" }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "uint256", "name": "tokenId", "type": "uint256" }
        ],
        "name": "getApproved",
        "outputs": [
          { "internalType": "address", "name": "", "type": "address" }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "owner", "type": "address" },
          { "internalType": "address", "name": "operator", "type": "address" }
        ],
        "name": "isApprovedForAll",
        "outputs": [
          { "internalType": "bool", "name": "", "type": "bool" }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "uint256", "name": "tokenId", "type": "uint256" }
        ],
        "name": "isTimeElapsed",
        "outputs": [
          { "internalType": "bool", "name": "", "type": "bool" }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "recipient", "type": "address" },
          { "internalType": "uint256", "name": "xMinutes", "type": "uint256" }
        ],
        "name": "mint",
        "outputs": [
          { "internalType": "uint256", "name": "", "type": "uint256" }
        ],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "name",
        "outputs": [
          { "internalType": "string", "name": "", "type": "string" }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "uint256", "name": "tokenId", "type": "uint256" }
        ],
        "name": "ownerOf",
        "outputs": [
          { "internalType": "address", "name": "", "type": "address" }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "from", "type": "address" },
          { "internalType": "address", "name": "to", "type": "address" },
          { "internalType": "uint256", "name": "tokenId", "type": "uint256" }
        ],
        "name": "safeTransferFrom",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "from", "type": "address" },
          { "internalType": "address", "name": "to", "type": "address" },
          { "internalType": "uint256", "name": "tokenId", "type": "uint256" },
          { "internalType": "bytes", "name": "data", "type": "bytes" }
        ],
        "name": "safeTransferFrom",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "operator", "type": "address" },
          { "internalType": "bool", "name": "approved", "type": "bool" }
        ],
        "name": "setApprovalForAll",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "bytes4", "name": "interfaceId", "type": "bytes4" }
        ],
        "name": "supportsInterface",
        "outputs": [
          { "internalType": "bool", "name": "", "type": "bool" }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [],
        "name": "symbol",
        "outputs": [
          { "internalType": "string", "name": "", "type": "string" }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "uint256", "name": "", "type": "uint256" }
        ],
        "name": "tokenInfo",
        "outputs": [
          { "internalType": "uint256", "name": "mintTime", "type": "uint256" },
          { "internalType": "uint256", "name": "duration", "type": "uint256" },
          { "internalType": "bool", "name": "eventEmitted", "type": "bool" }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "uint256", "name": "tokenId", "type": "uint256" }
        ],
        "name": "tokenURI",
        "outputs": [
          { "internalType": "string", "name": "", "type": "string" }
        ],
        "stateMutability": "view",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "address", "name": "from", "type": "address" },
          { "internalType": "address", "name": "to", "type": "address" },
          { "internalType": "uint256", "name": "tokenId", "type": "uint256" }
        ],
        "name": "transferFrom",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      },
      {
        "inputs": [
          { "internalType": "uint256", "name": "tokenId", "type": "uint256" }
        ],
        "name": "triggerTimeElapsed",
        "outputs": [],
        "stateMutability": "nonpayable",
        "type": "function"
      }
    ];

    // --- Web3Modal のセットアップ ---
    let web3Modal;
    let provider;    // Web3Modal により接続されたプロバイダー
    let signer;      // 接続されたウォレットの signer
    let walletConnected = false;
    let connection;  // 接続オブジェクト

    // WalletConnect をプロバイダーオプションとして設定
    const providerOptions = {
      walletconnect: {
        package: window.WalletConnectProvider.default, // UMD 版では default プロパティ経由
        options: {
          rpc: {
            // Polygon Amoy Testnet の chainId は 80002（Alchmey の RPC URL を指定）
            80002: RPC_URL
          }
        }
      }
    };

    // Web3Modal の初期化（ページ読み込み時）
    window.addEventListener('load', async () => {
      web3Modal = new window.Web3Modal.default({
        cacheProvider: false, // 自動接続しない
        providerOptions
      });
    });

    // 読み取り専用プロバイダーとして、Alchemy の RPC URL を利用
    const readProvider = new ethers.providers.JsonRpcProvider(RPC_URL);
    const contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, readProvider);

    // ウォレット接続用の関数（Web3Modal を利用）
    async function connectWallet() {
      try {
        connection = await web3Modal.connect();
        provider = new ethers.providers.Web3Provider(connection);
        signer = provider.getSigner();
        walletConnected = true;
        document.getElementById("output").textContent = "ウォレット接続成功。\nアドレス: " + await signer.getAddress();
      } catch (error) {
        console.error("ウォレット接続失敗", error);
        document.getElementById("output").textContent = "ウォレット接続失敗:\n" + error.message;
      }
    }

    document.getElementById("connectWalletButton").addEventListener("click", connectWallet);

    // --- 読み取り専用関数 isTimeElapsed(tokenId) の呼び出し ---
    document.getElementById("readButton").addEventListener("click", async function() {
      var output = document.getElementById("output");
      var tokenIdInput = prompt("Enter tokenId to check isTimeElapsed:");
      if (tokenIdInput === null) {
        output.textContent = "Operation cancelled.";
        return;
      }
      var tokenId = parseInt(tokenIdInput);
      if (isNaN(tokenId)) {
        output.textContent = "Invalid tokenId.";
        return;
      }
      output.textContent = "Calling isTimeElapsed...";
      try {
        var result = await contract.isTimeElapsed(tokenId);
        output.textContent = "TokenId " + tokenId + " isTimeElapsed result: " + result;
      } catch (error) {
        console.error(error);
        output.textContent = "Error occurred:\n" + error.message;
      }
    });

    // --- 状態変更関数 mint(signer.address, xMinutes) の呼び出し ---
    document.getElementById("writeButton").addEventListener("click", async function() {
      var output = document.getElementById("output");

      if (!walletConnected) {
        alert("ウォレットが接続されていません。先にウォレット接続してください。");
        return;
      }

      output.textContent = "Calling mint...\nPlease confirm the transaction in your wallet.";
      try {
        // 接続済みの signer を利用してコントラクトに接続
        const contractWithSigner = contract.connect(signer);

        var xMinutesInput = prompt("Enter xMinutes for mint:");
        if (xMinutesInput === null) {
          output.textContent = "Operation cancelled.";
          return;
        }
        var xMinutes = parseInt(xMinutesInput);
        if (isNaN(xMinutes)) {
          output.textContent = "Invalid xMinutes value.";
          return;
        }

        var signerAddress = await signer.getAddress();
        var tx = await contractWithSigner.mint(signerAddress, xMinutes);
        output.textContent = "Transaction sent: " + tx.hash + "\nWaiting for confirmation...";
        var receipt = await tx.wait();
        output.textContent += "\nTransaction confirmed in block " + receipt.blockNumber + ".";
      } catch (error) {
        console.error(error);
        output.textContent = "Error occurred:\n" + error.message;
      }
    });
  </script>
</body>
</html>
